{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
            <a href="/lore" class="text-gray-500 hover:text-gray-700 mr-4">&larr; Back</a>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">{{ adventure.title }}</h1>
                <p class="text-sm text-gray-500">Based on: {{ scenario.title }}</p>
            </div>
        </div>
        <div class="space-x-2">
            <button
                hx-post="/lore/adventures/{{ adventure.id }}/undo"
                hx-target="#story-history"
                hx-swap="innerHTML"
                class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 text-sm">
                Undo Last
            </button>
            <button
                hx-delete="/lore/adventures/{{ adventure.id }}"
                hx-confirm="Are you sure you want to delete this adventure?"
                hx-on::after-request="window.location.href='/lore'"
                class="bg-red-100 text-red-700 px-3 py-2 rounded-lg hover:bg-red-200 text-sm">
                Delete
            </button>
        </div>
    </div>

    <!-- Story Display -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div id="story-history" class="p-6 max-h-[60vh] overflow-y-auto space-y-4">
            {% for event in adventure.history %}
            <div class="story-event">
                {% if event.player_input and event.player_input != '[Adventure begins]' %}
                <div class="mb-2">
                    <span class="text-xs font-medium text-indigo-600 uppercase">{{ event.action_type.value }}</span>
                    <p class="text-gray-700 italic">&gt; {{ event.player_input }}</p>
                </div>
                {% endif %}
                <div class="prose prose-sm max-w-none text-gray-800 leading-relaxed">
                    {{ event.ai_response | safe }}
                </div>
            </div>
            {% if not loop.last %}
            <hr class="border-gray-100">
            {% endif %}
            {% endfor %}
        </div>

        <!-- Loading indicator -->
        <div id="story-loading" class="hidden p-4 text-center text-gray-500">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
            <p class="mt-2">The story unfolds...</p>
        </div>
    </div>

    <!-- Action Input -->
    <div class="bg-white rounded-lg shadow p-6">
        <form
            hx-post="/lore/adventures/{{ adventure.id }}/action"
            hx-target="#story-history"
            hx-swap="beforeend"
            hx-on::before-request="document.getElementById('story-loading').classList.remove('hidden')"
            hx-on::after-request="document.getElementById('story-loading').classList.add('hidden'); this.reset(); document.getElementById('story-history').scrollTop = document.getElementById('story-history').scrollHeight"
            class="space-y-4"
        >
            <div class="flex space-x-2">
                <select name="action_type" class="border rounded-lg px-3 py-2 bg-gray-50">
                    <option value="do">Do</option>
                    <option value="say">Say</option>
                    <option value="story">Story</option>
                </select>
                <input type="text" name="player_input" required
                    class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="What do you do?" autofocus>
                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                    Go
                </button>
            </div>

            <div class="text-xs text-gray-500 flex space-x-4">
                <span><strong>Do:</strong> Perform an action</span>
                <span><strong>Say:</strong> Speak as your character</span>
                <span><strong>Story:</strong> Narrate directly</span>
            </div>
        </form>
    </div>

    <!-- Story Summary (collapsible) -->
    <details class="mt-6 bg-gray-50 rounded-lg">
        <summary class="p-4 cursor-pointer font-medium text-gray-700 hover:bg-gray-100 rounded-lg">
            Story Summary & Memory
        </summary>
        <div class="p-4 pt-0 space-y-3">
            <div>
                <h4 class="text-sm font-medium text-gray-500">Current Summary</h4>
                <p class="text-sm text-gray-700">{{ adventure.current_story_summary or 'No summary yet.' }}</p>
            </div>
            <div>
                <h4 class="text-sm font-medium text-gray-500">Memory</h4>
                <p class="text-sm text-gray-700">{{ adventure.memory or 'No memory set.' }}</p>
            </div>
        </div>
    </details>
</div>

<style>
.prose p { margin-bottom: 0.75rem; }
.prose p:last-child { margin-bottom: 0; }
</style>
{% endblock %}
